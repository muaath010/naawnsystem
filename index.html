<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فريق نعاون لخدمات التوصيل</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #D4AF37;
            --red: #800000;
            --red-bright: #b30000;
            --light-bg: #fdfdfd;
            --card-bg: #ffffff; 
            --text: #333333;    
            --text-light: #666666;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--light-bg);
            color: var(--text);
            text-align: center;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            width: 100%;
            padding: 30px 20px;
            background: linear-gradient(to bottom, var(--red), var(--light-bg));
            border-bottom: 2px solid var(--gold);
            margin-bottom: 30px;
        }

        .logo-container {
            position: relative;
            width: 120px; height: 120px;
            margin: 0 auto 15px auto;
        }

        .logo-container img {
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 3px solid var(--gold);
            object-fit: cover;
        }

        h1 { color: var(--gold); font-size: 2.5rem; margin-bottom: 5px; }
        .slogan { font-size: 1.1rem; font-weight: bold; }

        .menu-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 90%;
            max-width: 400px;
        }

        .main-btn {
            background: var(--card-bg);
            border: 2px solid var(--red);
            color: var(--red);
            padding: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 15px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-btn:hover {
            background: var(--red);
            color: white;
        }

        .page-section {
            display: none;
            background-color: var(--card-bg);
            width: 95%;
            max-width: 500px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-bottom: 40px;
        }

        .input-group { margin-bottom: 20px; text-align: right; }
        label { display: block; margin-bottom: 8px; font-weight: bold; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; text-align: right; font-family: 'Tajawal'; }
        
        .submit-btn {
            width: 100%; padding: 15px;
            background: var(--red); color: white;
            border: none; border-radius: 12px;
            font-size: 1.1rem; font-weight: bold; cursor: pointer;
        }

        .back-btn { margin-top: 15px; background: none; border: 1px solid #ccc; padding: 10px 20px; border-radius: 20px; cursor: pointer; }

        .loader { display: none; border: 4px solid #f3f3f3; border-top: 4px solid var(--red); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #eee; font-size: 0.85rem; }
        th { background: var(--red); color: white; }
        .stat-box { background: #fff5f5; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--red); }
    </style>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="https://i.imgur.com/nYQiffV.png" alt="شعار فريق نعاون">
        </div>
        <h1>فريق نعاون</h1>
        <div class="slogan">لخدمات التوصيل الاحترافية</div>
    </header>

    <div id="mainMenu" class="menu-container">
        <button class="main-btn" onclick="showSection('driverLoginSec')">دخول المناديب</button>
        <button class="main-btn" onclick="showSection('deductionSec')">لوحة الاستقطاعات</button>
        <button class="main-btn" onclick="showSection('invoiceSec')">لوحة فواتير الطلبات</button>
        <button class="main-btn" onclick="showSection('settingsSec')">دخول شركاء المطاعم</button>
    </div>

    <div id="driverLoginSec" class="page-section">
        <h2>دخول المناديب</h2>
        <div class="input-group">
            <label>رقم بطاقة المندوب</label>
            <input type="text" id="driverCardID" placeholder="أدخل رقم البطاقة">
        </div>
        <button onclick="loginDriver()" class="submit-btn">تسجيل الدخول</button>
        <div id="loaderLogin" class="loader"></div>
        <button class="back-btn" onclick="goBack()">عودة</button>
    </div>

    <div id="driverDashboard" class="page-section">
        <h2 id="welcomeDriver">أهلاً بك</h2>
        <div class="stat-box">
            <p>إجمالي طلبياتك المسجلة:</p>
            <h3 id="orderCountDisplay" style="font-size: 2rem; color: var(--red);">0</h3>
        </div>
        <button class="submit-btn" onclick="showSection('deductionSec')">تسجيل استقطاع جديد</button>
        <button class="back-btn" onclick="location.reload()">تسجيل خروج</button>
    </div>

    <div id="deductionSec" class="page-section">
        <h2>تسجيل استقطاع</h2>
        <form id="deductionForm" onsubmit="submitDeduction(event)">
            <input type="hidden" name="driver_card" id="hiddenCardID">
            <div class="input-group">
                <label>اسم المندوب</label>
                <input type="text" name="driver_name" required>
            </div>
            <div class="input-group">
                <label>عدد الطلبات</label>
                <input type="number" name="orders_count" required>
            </div>
            <div class="input-group">
                <label>التاريخ</label>
                <input type="date" name="date_val" required>
            </div>
            <div class="input-group">
                <label>الاستقطاع الكلي (ر.ع)</label>
                <input type="text" name="deduction" required>
            </div>
            <button type="submit" class="submit-btn">إرسال</button>
            <div id="loader1" class="loader"></div>
        </form>
        <button class="back-btn" onclick="goBack()">عودة</button>
    </div>

    <div id="invoiceSec" class="page-section">
        <h2>تسجيل فاتورة</h2>
        <form id="invoiceForm" onsubmit="submitInvoice(event)">
            <div class="input-group"><label>اسم المطعم</label><input type="text" name="rest_name" required></div>
            <div class="input-group"><label>اسم المندوب</label><input type="text" name="driver_name" required></div>
            <div class="input-group"><label>المكان</label><input type="text" name="location" required></div>
            <div class="input-group"><label>التاريخ</label><input type="date" name="date_val" required></div>
            <div class="input-group"><label>القيمة</label><input type="number" step="0.01" name="price" required></div>
            <button type="submit" class="submit-btn">إرسال الفاتورة</button>
            <div id="loader2" class="loader"></div>
        </form>
        <button class="back-btn" onclick="goBack()">عودة</button>
    </div>

    <div id="settingsSec" class="page-section">
        <div id="loginBlock">
            <h2>دخول المطاعم</h2>
            <div class="input-group"><label>اسم المطعم</label><input type="text" id="loginRestName"></div>
            <div class="input-group"><label>الرمز السري</label><input type="password" id="loginPass"></div>
            <button onclick="checkLogin()" class="submit-btn">دخول</button>
            <div id="loader3" class="loader"></div>
        </div>
        <div id="dashboardBlock" style="display:none;">
            <h3 id="dashTitle"></h3>
            <div id="resultsArea"></div>
            <button class="back-btn" onclick="location.reload()">خروج</button>
        </div>
        <button class="back-btn" id="restaurantBackBtn" onclick="goBack()">عودة</button>
    </div>

    <script>
        // ضع رابط URL الخاص بـ Web App هنا
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIuDqE0uK_pID_f9KIn0uB8FvF9V_W9K0S-R3N-2I/exec"; 

        function showSection(id) {
            document.getElementById('mainMenu').style.display = 'none';
            document.querySelectorAll('.page-section').forEach(s => s.style.display = 'none');
            document.getElementById(id).style.display = 'block';
        }

        function goBack() {
            document.querySelectorAll('.page-section').forEach(s => s.style.display = 'none');
            document.getElementById('mainMenu').style.display = 'flex';
        }

        function loginDriver() {
            const id = document.getElementById('driverCardID').value;
            if(!id) return alert("أدخل رقم البطاقة");
            document.getElementById('loaderLogin').style.display = 'block';

            fetch(`${SCRIPT_URL}?query=drivers`)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loaderLogin').style.display = 'none';
                const count = data.filter(row => row[1] == id).length;
                document.getElementById('orderCountDisplay').innerText = count;
                document.getElementById('hiddenCardID').value = id;
                document.getElementById('welcomeDriver').innerText = "أهلاً بك مندوب رقم: " + id;
                showSection('driverDashboard');
            }).catch(() => {
                alert("خطأ في الاتصال");
                document.getElementById('loaderLogin').style.display = 'none';
            });
        }

        function submitDeduction(e) {
            e.preventDefault();
            document.getElementById('loader1').style.display = 'block';
            const params = new URLSearchParams(new FormData(e.target));
            params.append('action', 'addDeduction');

            fetch(SCRIPT_URL, { method: 'POST', body: params })
            .then(() => {
                alert("تم الإرسال ✅");
                e.target.reset();
                location.reload();
            }).catch(() => alert("فشل الإرسال"));
        }

        function submitInvoice(e) {
            e.preventDefault();
            document.getElementById('loader2').style.display = 'block';
            const params = new URLSearchParams(new FormData(e.target));
            params.append('action', 'addInvoice');

            fetch(SCRIPT_URL, { method: 'POST', body: params })
            .then(() => {
                alert("تم إرسال الفاتورة ✅");
                e.target.reset();
                goBack();
            }).catch(() => alert("فشل الإرسال"));
        }

        function checkLogin() {
            const name = document.getElementById('loginRestName').value;
            const pass = document.getElementById('loginPass').value;
            if(pass !== "res9090") return alert("كلمة السر خطأ");
            
            document.getElementById('loader3').style.display = 'block';
            fetch(SCRIPT_URL)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loader3').style.display = 'none';
                const orders = data.filter(row => row[1] == name);
                let html = '<table><tr><th>المندوب</th><th>المكان</th><th>القيمة</th></tr>';
                orders.forEach(r => html += `<tr><td>${r[2]}</td><td>${r[3]}</td><td>${r[6]}</td></tr>`);
                html += '</table>';
                document.getElementById('resultsArea').innerHTML = html;
                document.getElementById('loginBlock').style.display = 'none';
                document.getElementById('restaurantBackBtn').style.display = 'none';
                document.getElementById('dashboardBlock').style.display = 'block';
                document.getElementById('dashTitle').innerText = "طلبات مطعم: " + name;
            });
        }
    </script>
</body>
</html>
